---
apiVersion: batch/v1
kind: Job
metadata:
  name: 3scale-toolbox
  namespace: {{ .Values.threeScale.namespace }}
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/sync-wave: "0"
spec:
  backoffLimit: 1
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: toolbox
        image: registry.redhat.io/3scale-amp2/toolbox-rhel9:1.11.0
        command: ["/bin/bash", "-c"]
        args:
        - |
          CLEAN_ADMIN_URL=$(echo $ADMIN_URL | sed 's|^https://||')
          3scale remote add maas "https://$TOKEN@$CLEAN_ADMIN_URL"
          3scale service list maas

          echo "Creating application for alice..."
          3scale application apply maas aliceInWonderland \
            --account="alice" \
            --name="Alice Application" \
            --description="Application for Alice" \
            --plan="standard" \
            --service="granite-3dot2-8b-instruct"

          echo "Job completed."
        env:
        - name: ADMIN_URL
          valueFrom:
            secretKeyRef:
              name: 3scale-maas-tenant-secret
              key: adminURL
        - name: TOKEN
          valueFrom:
            secretKeyRef:
              name: 3scale-maas-tenant-secret
              key: token
